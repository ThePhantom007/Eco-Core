<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoCore Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/style.css">

    <style>
        /* --- MODAL STYLES (Popup Logic) --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {transform: translateY(-50px); opacity: 0;}
            to {transform: translateY(0); opacity: 1;}
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover { color: #000; }

        /* --- CLICKABLE CARDS --- */
        .summary-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        /* Simulation Panel Style */
        .sim-panel {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #90caf9;
        }

        /* Forecast Card Style */
        .forecast-card {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 1px solid #a5d6a7;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1><i class="fas fa-leaf"></i> EcoCore OS</h1>
            <p>Sustainability Operating System</p>
        </div>
        <div class="status-badge">
            <i class="fas fa-wifi"></i> System Online
        </div>
    </header>

    <div class="card sim-panel">
        <h2><i class="fas fa-gamepad"></i> Digital Twin Controller (Simulation)</h2>
        <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">

            <div style="flex: 1; min-width: 200px;">
                <label for="occupancy">Occupancy: <span id="occ-val" style="font-weight:bold">0</span> people</label>
                <input type="range" id="occupancy" min="0" max="100" value="0" style="width:100%"
                       oninput="document.getElementById('occ-val').innerText = this.value">
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label for="energy">Energy Load: <span id="energy-val" style="font-weight:bold">0.5</span> kW</label>
                <input type="range" id="energy" min="0" max="5.0" step="0.1" value="0.5" style="width:100%"
                       oninput="document.getElementById('energy-val').innerText = this.value">
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label for="water">Water Flow: <span id="water-val" style="font-weight:bold">0.0</span> L/min</label>
                <input type="range" id="water" min="0" max="10.0" step="0.1" value="0.0" style="width:100%"
                       oninput="document.getElementById('water-val').innerText = this.value">
            </div>

            <button onclick="sendSimData()" style="
                background: var(--primary-green); color: white; border: none;
                padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <i class="fas fa-satellite-dish"></i> Send to AI
            </button>
        </div>
        <p id="sim-status" style="margin-top: 15px; font-weight: 500; height: 20px;"></p>
    </div>

    <div class="metrics-grid">

        <div class="card summary-card" onclick="openModal('waterModal')">
            <h2><i class="fas fa-water"></i> Water System</h2>
            <h1 id="water-total-savings">‚Çπ0.00</h1>
            <p>Saved this week</p>
            <small style="color: var(--accent-teal)">Click for Graph & History &rarr;</small>
        </div>

        <div class="card summary-card" onclick="openModal('batteryModal')">
            <h2><i class="fas fa-bolt"></i> Battery System</h2>
            <h1 id="battery-total-savings">‚Çπ0.00</h1>
            <p>Saved this week</p>
            <small style="color: var(--accent-teal)">Click for Graph & History &rarr;</small>
        </div>

        <div class="card summary-card forecast-card" style="cursor: default;">
            <h2><i class="fas fa-crystal-ball"></i> AI Forecast (30 Days)</h2>
            <h1 id="forecast-bill">Loading...</h1>
            <p id="forecast-water">Projecting usage...</p>
            <small id="forecast-status" style="font-weight: bold; color: #2e7d32;"></small>
        </div>

        <div class="card summary-card" onclick="openModal('alertsModal')">
            <h2><i class="fas fa-bell"></i> Active Monitoring</h2>
            <h1 id="alert-count">0</h1>
            <p>Events Detected</p>
            <small style="color: var(--accent-teal)">Click for Audit Log &rarr;</small>
        </div>
    </div>
</div>

<div id="waterModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('waterModal')">&times;</span>
        <h2>üíß Water Pumping Analysis</h2>
        <div style="height: 300px; margin-bottom: 20px;">
            <canvas id="waterChart"></canvas>
        </div>
        <h3>History Log</h3>
        <table id="water-table">
            <thead><tr><th>Date</th><th>Volume</th><th>Actual Cost</th><th>Savings</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="batteryModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('batteryModal')">&times;</span>
        <h2>‚ö° Battery Arbitrage Analysis</h2>
        <div style="height: 300px; margin-bottom: 20px;">
            <canvas id="batteryChart"></canvas>
        </div>
        <h3>History Log</h3>
        <table id="battery-table">
            <thead><tr><th>Date</th><th>Energy Added</th><th>Actual Cost</th><th>Savings</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="alertsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('alertsModal')">&times;</span>
        <h2>üîî System Alerts & Impact</h2>
        <table id="alerts-table">
            <thead><tr><th>Time</th><th>Type</th><th>Impact</th><th>Savings</th><th>Confidence</th><th>Status</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    const API_BASE = "";

    // Global Storage
    let waterData = [];
    let batteryData = [];
    let alertData = [];

    // --- 1. DATA FETCHING ---
    async function refreshData() {
        try {
            // Fetch All Data in Parallel
            const [pumpRes, battRes, alertRes, forecastRes] = await Promise.all([
                fetch(`${API_BASE}/api/history/pumping`),
                fetch(`${API_BASE}/api/history/battery`),
                fetch(`${API_BASE}/api/history/alerts`),
                fetch(`${API_BASE}/api/forecast/budget`) // Fetch Forecast
            ]);

            waterData = await pumpRes.json();
            batteryData = await battRes.json();
            alertData = await alertRes.json();
            const forecastData = await forecastRes.json();

            // UPDATE UI
            updateSummaryCards(forecastData);
            renderTables();

            // Note: Graphs are drawn only when modal opens

        } catch (error) {
            console.error("Error fetching data:", error);
        }
    }

    // --- 2. UPDATE CARDS (With Forecast) ---
    function updateSummaryCards(forecast) {
        // Water Savings
        let waterSavings = waterData.reduce((acc, item) => {
            let val = parseFloat(item.money_saved.replace(/[‚Çπ,]/g, '')) || 0;
            return acc + val;
        }, 0);
        document.getElementById('water-total-savings').innerText = "‚Çπ" + waterSavings.toFixed(2);

        // Battery Savings
        let battSavings = batteryData.reduce((acc, item) => {
            let val = parseFloat(item.money_saved.replace(/[‚Çπ,]/g, '')) || 0;
            return acc + val;
        }, 0);
        document.getElementById('battery-total-savings').innerText = "‚Çπ" + battSavings.toFixed(2);

        // Alerts
        document.getElementById('alert-count').innerText = alertData.length;

        // Forecast Card
        if (forecast) {
            document.getElementById('forecast-bill').innerText = forecast.projected_bill;
            document.getElementById('forecast-water').innerText = `Est. Usage: ${forecast.projected_water_usage}`;

            const statusElem = document.getElementById('forecast-status');
            statusElem.innerText = forecast.status;
            statusElem.style.color = forecast.status.includes("Under") ? "#2e7d32" : "#d32f2f";
        }
    }

    // --- 3. RENDER TABLES ---
    function renderTables() {
        // Water
        document.querySelector('#water-table tbody').innerHTML = waterData.map(item => `
            <tr>
                <td>${item.date}</td>
                <td>${item.total_water_pumped}</td>
                <td>${item.total_cost}</td>
                <td style="color:green; font-weight:bold">${item.money_saved}</td>
            </tr>
        `).join('');

        // Battery
        document.querySelector('#battery-table tbody').innerHTML = batteryData.map(item => `
            <tr>
                <td>${item.date}</td>
                <td>${item.energy_added}</td>
                <td>${item.total_cost}</td>
                <td style="color:green; font-weight:bold">${item.money_saved}</td>
            </tr>
        `).join('');

        // Alerts
        document.querySelector('#alerts-table tbody').innerHTML = alertData.map(item => `
            <tr class="alert-row ${item.type}">
                <td>${new Date(item.time).toLocaleTimeString()}</td>
                <td><b>${item.type}</b><br><small>${item.message}</small></td>
                <td style="color:#d32f2f;">${item.probable_wastage || '-'}</td>
                <td style="color:green; font-weight:bold;">${item.estimated_savings || '-'}</td>
                <td>${item.probability_score}</td>
                <td><span class="status-badge">${item.action}</span></td>
            </tr>
        `).join('');
    }

    // --- 4. SIMULATION LOGIC ---
    async function sendSimData() {
        const occ = parseInt(document.getElementById('occupancy').value);
        const energy = parseFloat(document.getElementById('energy').value);
        const water = parseFloat(document.getElementById('water').value);
        const btn = document.querySelector('button');

        // Visual Feedback
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        document.getElementById('sim-status').innerText = "Sending sensor packet to AI Model...";

        const payload = {
            "room_id": "Demo Room A",
            "occupancy": occ,
            "light_lux": occ > 0 ? 500 : 0,
            "water_flow": water,
            "energy_load": energy
        };

        try {
            const res = await fetch(`${API_BASE}/sensor/ingest`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const result = await res.json();

            if (result.alert) {
                document.getElementById('sim-status').innerHTML =
                    `<span style="color:#d32f2f; font-weight:bold"><i class="fas fa-exclamation-triangle"></i> ALERT: ${result.alert.type} (Confidence: ${result.alert.probability_score})</span>`;
                // Instant Refresh
                refreshData();
            } else {
                document.getElementById('sim-status').innerHTML =
                    `<span style="color:#2e7d32; font-weight:bold"><i class="fas fa-check-circle"></i> Normal Operation. AI Prediction: ${result.debug.ai_water_normal.toFixed(1)}L</span>`;
            }
        } catch (err) {
            console.error(err);
            document.getElementById('sim-status').innerText = "‚ùå Connection Error";
        } finally {
            btn.innerHTML = '<i class="fas fa-satellite-dish"></i> Send to AI';
        }
    }

    // --- 5. MODALS & GRAPHS ---
    function openModal(modalId) {
        document.getElementById(modalId).style.display = "block";
        if (modalId === 'waterModal') drawChart('waterChart', waterData, 'peak_cost_comparison', 'total_cost');
        if (modalId === 'batteryModal') drawChart('batteryChart', batteryData, 'peak_cost_comparison', 'total_cost');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) event.target.style.display = "none";
    }

    // --- 6. FLICKER-FREE CHART BUILDER ---
    function drawChart(canvasId, rawData, keyHigh, keyLow) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        // Sort Data by Date
        const sorted = rawData.slice().sort((a,b) => new Date(a.date) - new Date(b.date));
        const labels = sorted.map(i => i.date);
        const dataHigh = sorted.map(i => i[keyHigh]); // Peak Cost
        const dataLow = sorted.map(i => i[keyLow]);   // Our Cost

        // Check if chart exists
        if (window[canvasId] instanceof Chart) {
            window[canvasId].data.labels = labels;
            window[canvasId].data.datasets[0].data = dataHigh;
            window[canvasId].data.datasets[1].data = dataLow;
            window[canvasId].update('none');
        } else {
            window[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Standard Cost (Peak)', data: dataHigh, borderColor: '#ff5252', backgroundColor: 'rgba(255, 82, 82, 0.1)', fill: true, tension: 0.4 },
                        { label: 'EcoCore Cost (Optimized)', data: dataLow, borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.2)', fill: true, tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true } } }
            });
        }
    }

    // INIT
    refreshData();
    setInterval(refreshData, 3000); // 3-Second Auto Refresh

</script>
</body>
</html>